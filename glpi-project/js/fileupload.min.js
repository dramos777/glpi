/**
 * ---------------------------------------------------------------------
 *
 * GLPI - Gestionnaire Libre de Parc Informatique
 *
 * http://glpi-project.org
 *
 * @copyright 2015-2022 Teclib' and contributors.
 * @copyright 2003-2014 by the INDEPNET Development Team.
 * @licence   https://www.gnu.org/licenses/gpl-3.0.html
 *
 * ---------------------------------------------------------------------
 *
 * LICENSE
 *
 * This file is part of GLPI.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *
 * ---------------------------------------------------------------------
 */
var insertIntoEditor=[];function uploadFile(e,t){insertIntoEditor[e.name]=isImage(e);var a=$(t.getElement()).siblings(".fileupload");if(a.length===0){a=$(t.getElement()).closest("form").find(".fileupload")}a.find('[type="file"]').fileupload("add",{files:[e]})}var handleUploadedFile=function(e,t,a,n,r){$.ajax({type:"POST",url:CFG_GLPI.root_doc+"/ajax/getFileTag.php",data:{data:t},dataType:"JSON",success:function(i){$.each(e,(function(e,o){if(t[e].error!==undefined){n.parent().find(".uploadbar").text(t[e].error).css("width","100%");return}var d=i[e];var l=null;if(r&&Object.prototype.hasOwnProperty.call(insertIntoEditor,o.name)&&insertIntoEditor[o.name]){l=tinyMCE.get(r);insertImgFromFile(l,o,d.tag);a=l.targetElm.name}displayUploadedFile(t[e],d,l,a,n);n.parent().find(".uploadbar").text(__("Upload successful")).css("width","100%").delay(2e3).fadeOut("slow")}))},error:function(e){console.warn(e.responseText)},complete:function(){$.each(e,(function(e,t){delete insertIntoEditor[t.name]}))}})};var fileindex=0;var displayUploadedFile=function(e,t,a,n,r){var i=e.name.split(".").pop();var o=$("<p></p>").attr("id",e.id).html(getExtIcon(i)+"&nbsp;"+"<b>"+e.display+"</b>"+"&nbsp;("+getSize(e.size)+")&nbsp;").appendTo(r);$("<input/>").attr("type","hidden").attr("name","_"+n+"["+fileindex+"]").attr("value",e.name).appendTo(o);$("<input/>").attr("type","hidden").attr("name","_prefix_"+n+"["+fileindex+"]").attr("value",e.prefix).appendTo(o);$("<input/>").attr("type","hidden").attr("name","_tag_"+n+"["+fileindex+"]").attr("value",t.name).appendTo(o);var d={0:e.id,1:e.id+"2"};$('<span class="ti ti-circle-x pointer"></span>').click((function(){deleteImagePasted(d,t.tag,a)})).appendTo(o);fileindex++};var deleteImagePasted=function(e,t,a){$.each(e,(function(e,t){$("#"+t).remove()}));if(typeof a!=="undefined"&&typeof a.dom!=="undefined"){a.setContent(a.getContent().replace("<p>"+t+"</p>",""));var n=new RegExp("#","g");a.dom.remove(t.replace(n,""))}};var insertImgFromFile=function(e,t,a){var n=window.URL||window.webkitURL;var r=n.createObjectURL(t);var i=new RegExp("#","g");var o=$(tinyMCE.activeEditor.getContainer()).height()-60;var d=$(tinyMCE.activeEditor.getContainer()).width()-120;if(window.FileReader&&window.File&&window.FileList&&window.Blob){e.setProgressState(true);var l=new FileReader;l.onload=function(t){var n=new Image;n.src=t.target.result;n.onload=function(){var t=this.width;var n=this.height;var l=0;if(t>d){l=d/t;n=n*l;t=t*l}if(n>o){l=o/n;t=t*l;n=n*l}e.execCommand("mceInsertContent",false,"<img width='"+t+"' height='"+n+"' id='"+a.replace(i,"")+"' src='"+r+"'>");e.setProgressState(false)}};l.readAsDataURL(t)}else{console.warn("thanks to update your browser to get preview of image")}};var dataURItoBlob=function(e){var t;if(e.split(",")[0].indexOf("base64")>=0){t=atob(e.split(",")[1])}else{t=unescape(e.split(",")[1])}var a=e.split(",")[0].split(":")[1].split(";")[0];var n=a.split("/")[1];var r=new Uint8Array(t.length);for(var i=0;i<t.length;i++){r[i]=t.charCodeAt(i)}var o=new Blob([r],{type:a});o.name="image_paste"+Math.floor(Math.random()*1e7+1)+"."+n;return o};var isImageFromPaste=function(e){return e.match(new RegExp("<img.*data:image/"))!==null};var isImageBlobFromPaste=function(e){return e.match(new RegExp("<img.*src=['\"]blob:"))!==null};var extractSrcFromImgTag=function(e){var t=$("<div></div>").append(e).find("img");if(t.length>0){return t.attr("src")}return""};var insertImageInTinyMCE=function(e,t){uploadFile(t,e)};if(typeof tinyMCE!="undefined"){tinyMCE.PluginManager.add("glpi_upload_doc",(function(e){e.on("PastePreProcess",(function(t){if(isImageFromPaste(t.content)){stopEvent(t);var a=extractSrcFromImgTag(t.content);if(a.length){var n=dataURItoBlob(a);insertImageInTinyMCE(e,n)}}else if(isImageBlobFromPaste(t.content)){stopEvent(t);var r=extractSrcFromImgTag(t.content);var i=new XMLHttpRequest;i.open("GET",r,true);i.responseType="blob";i.onload=function(){if(this.status!==200){console.error("paste error");return}var t=this.response;if(/^image\/.+/.test(t.type)){var a=t.type.replace("image/","");t.name="image_paste"+Math.floor(Math.random()*1e7+1)+"."+a;insertImageInTinyMCE(e,t)}};i.send()}$(".draghoverable").removeClass("draghover")}))}))}$((function(){$(document).bind("dragover",(function(e){e.preventDefault();var t=$(".dropzone");var a;var n=window.dropZoneTimeout;if(!n){t.addClass("dragin")}else{clearTimeout(n)}var r=false;var i=e.target;do{if($(i).hasClass("draghoverable")){r=true;a=$(i);break}i=i.parentNode}while(i!==null);t.removeClass("dragin draghover");if(r){a.addClass("draghover")}}));$(document).bind("drop",(function(e){e.preventDefault();$(".draghoverable").removeClass("draghover")}))}));